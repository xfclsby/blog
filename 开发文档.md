# 静态博客网站开发文档（基于 GitHub API）

## 1. 项目概述

本项目是一个 **纯静态** 的单页应用（SPA）博客系统，完全托管在 **GitHub Pages** 上。它利用 GitHub 提供的 REST API 将 GitHub 仓库本身作为“数据库”和“文件服务器”，实现了无后端（Serverless）的内容管理和发布流程。

### 1.1 核心特性
*   **无后端架构**：不需要购买服务器或配置数据库，所有数据存储在 GitHub 仓库中。
*   **GitHub 托管**：利用 GitHub Pages 免费托管前端页面。
*   **Git 作为数据库**：文章以 Markdown 文件形式存储，图片以文件形式存储在仓库中。
*   **在线管理**：通过输入 GitHub Personal Access Token (PAT) 进行身份验证，直接在前端页面调用 GitHub API 进行文章增删改查和文件上传。

---

## 2. 技术选型

### 2.1 前端框架
*   **核心框架**: React 18 (使用 Hooks)
*   **构建工具**: Vite (快速构建，配置简单)
*   **路由管理**: React Router v6 (实现 SPA 路由)
*   **状态管理**: Context API + useReducer (轻量级状态管理) 或 Zustand
*   **UI 组件库**: Tailwind CSS + Headless UI (由用户自定义样式) 或 Ant Design (快速开发后台管理功能)
*   **Markdown 渲染**: `react-markdown` + `remark-gfm` (支持 GitHub 风格 Markdown)
*   **API 交互**: Axios 或 Fetch API (直接调用 GitHub REST API)

### 2.2 数据存储与托管
*   **代码仓库**: GitHub Repository (Public/Private 均可，建议 Public 用于 Pages 部署)
*   **页面托管**: GitHub Pages
*   **图片/文件存储**: 仓库内的 `public/uploads` 目录或指定分支
*   **身份验证**: GitHub Personal Access Token (PAT)

---

## 3. 系统架构设计

### 3.1 数据流向
1.  **读取 (Read)**: 访客访问博客 -> 前端请求 `https://raw.githubusercontent.com/...` 或 GitHub Contents API -> 获取文章列表/内容 -> 渲染页面。
2.  **写入 (Write)**: 博主登录（输入 Token）-> 前端调用 `PUT /repos/{owner}/{repo}/contents/{path}` -> GitHub 提交 Commit -> 触发 GitHub Pages 自动构建（可选）或直接更新源文件。

### 3.2 目录结构规划 (建议)

```
my-static-blog/
├── public/
│   ├── uploads/          # 存放上传的图片/文件 (通过 API 写入此处)
│   ├── music/            # 存放上传的音乐文件 (MP3/OGG)
│   └── index.html
├── src/
│   ├── assets/
│   ├── components/       # 公共组件
│   │   ├── MusicPlayer.jsx # 全局音乐播放器组件
│   │   └── ...
│   ├── pages/
│   │   ├── MusicList.jsx # 音乐列表页
│   │   └── ...
│   ├── services/
│   │   └── github.js
│   ├── utils/
│   ├── App.jsx
│   └── main.jsx
├── posts/                # [数据存储] 存放博客文章 Markdown 文件
├── package.json
└── vite.config.js
```

---

## 4. 功能实现详情

### 4.1 身份验证 ("登录")
由于没有后端服务器，我们无法实现传统的 Session/JWT 登录。
*   **机制**: 用户在前端输入 **GitHub Personal Access Token (Classic)**。
*   **存储**: Token 加密或明文存储在浏览器的 `localStorage` 中（风险提示：仅限个人设备使用，不要在公共电脑操作）。
*   **权限验证**: 每次调用 API 时，在 Header 中携带 `Authorization: token YOUR_PAT`。
*   **注册**: 指导用户去 GitHub Settings -> Developer settings -> Personal access tokens 申请 Token（需勾选 `repo` 权限）。

### 4.2 文章管理 (CRUD)
所有操作均通过 GitHub Contents API 实现：`https://api.github.com/repos/{owner}/{repo}/contents/{path}`

*   **获取列表 (List)**:
    *   `GET /repos/{owner}/{repo}/contents/posts`
    *   解析返回的 JSON 数组，获取文件名列表。
*   **获取内容 (Get)**:
    *   `GET /repos/{owner}/{repo}/contents/posts/{filename}`
    *   API 返回的内容是 Base64 编码的，前端需解码 (`atob` 或 `js-base64`)。
*   **新建/更新 (Create/Update)**:
    *   `PUT /repos/{owner}/{repo}/contents/posts/{filename}`
    *   Body:
        ```json
        {
          "message": "Create new post",
          "content": "Base64EncodedContent...",
          "sha": "file_sha_if_updating" // 更新时必须带上原文件的 SHA
        }
        ```
*   **删除 (Delete)**:
    *   `DELETE /repos/{owner}/{repo}/contents/posts/{filename}`
    *   Body: `{"message": "Delete post", "sha": "original_file_sha"}`

### 4.3 音乐功能 (上传与播放)

#### 4.3.1 音乐文件上传
流程与图片上传一致，但需注意文件大小限制（GitHub API 单文件限制 100MB，但在浏览器端 Base64 编码过大可能导致卡顿，建议限制在 10-20MB 以内）。

1.  **上传接口**: `PUT /repos/{owner}/{repo}/contents/public/music/{filename}`
2.  **前端实现**:
    *   使用 `<input type="file" accept="audio/*" />` 选择文件。
    *   `FileReader` 转 Base64。
    *   调用 GitHub API 上传。

#### 4.3.2 音乐列表与播放
1.  **获取音乐列表**:
    *   调用 `GET /repos/{owner}/{repo}/contents/public/music` 获取所有音乐文件信息。
    *   过滤出 `.mp3`, `.ogg`, `.wav` 等格式文件。
    *   获取每个文件的 `download_url`。
2.  **全局播放器 (MusicPlayer 组件)**:
    *   使用 HTML5 `<audio>` 标签或 `react-h5-audio-player` 库。
    *   状态管理：当前播放歌曲、播放状态 (Playing/Paused)、播放列表。
    *   悬浮在页面底部，切换页面不中断播放（需放在 `Layout` 组件外层或作为顶层 Context）。

### 4.4 文件上传 (通用)
与创建文章类似，将图片文件转换为 Base64 字符串后上传。

1.  **用户选择文件**: `<input type="file" />`
2.  **读取文件**: 使用 `FileReader` 读取为 DataURL。
3.  **提取 Base64**: 去掉前缀 `data:image/png;base64,`。
4.  **调用 API**:
    *   `PUT /repos/{owner}/{repo}/contents/public/uploads/{timestamp}_{filename}`
    *   上传成功后，API 会返回 `download_url`。
5.  **插入文章**: 将返回的 URL (通常是 `raw.githubusercontent.com/...` 或 CDN 链接) 插入 Markdown 编辑器。

### 4.5 评论系统 (基于 Giscus)
由于是纯静态博客，推荐使用基于 GitHub Discussions 的评论系统 **Giscus**。
*   **配置**: 在 GitHub 仓库开启 Discussions 功能。
*   **安装**: 在 [giscus.app](https://giscus.app/zh-CN) 配置仓库，获取 `<script>` 标签或 React 组件配置。
*   **集成**: 使用 `@giscus/react` 组件，在文章详情页底部引入。它会自动根据文章标题或 URL 在 GitHub Discussions 中创建对应的话题。

### 4.6 分类、标签与搜索
通过解析 Markdown 文件的 **Front Matter** (YAML 头) 来实现。
*   **元数据示例**:
    ```yaml
    ---
    title: "我的第一篇博客"
    date: "2023-10-01"
    tags: ["React", "GitHub"]
    category: "技术"
    ---
    ```
*   **实现逻辑**:
    1.  获取文章列表时，并发请求获取所有文章内容（或仅获取前 N 篇的元数据，若文章量大需生成 `index.json`）。
    2.  使用 `gray-matter` 解析 Front Matter。
    3.  **分类/标签页**: 遍历所有文章，统计 Tag/Category 出现次数，生成索引页。
    4.  **搜索**: 前端过滤文章标题和元数据，实现实时搜索。

### 4.7 SEO 优化 (SEO)
SPA (单页应用) 对 SEO 不友好，建议使用 `react-helmet-async` 动态修改页面 `<title>` 和 `<meta>` 标签。
*   **首页**: 设置全局 Title, Description, Keywords。
*   **文章页**: 将 Title 设置为文章标题，Description 设置为文章摘要（截取前 100 字）。

---

## 5. 开发步骤指南

### 第一步：初始化项目与仓库
1.  在 GitHub 上创建一个新仓库（例如 `my-blog`）。
2.  本地初始化 React 项目：`npm create vite@latest my-blog -- --template react`
3.  安装依赖：
    ```bash
    npm install axios react-router-dom react-markdown gray-matter \
    react-helmet-async @giscus/react react-icons dayjs \
    classnames tailwindcss postcss autoprefixer
    ```
4.  初始化 Tailwind CSS: `npx tailwindcss init -p`

### 第二步：配置 GitHub API 服务
创建 `src/services/github.js`，封装 API 调用。
```javascript
import axios from 'axios';

const GITHUB_API_URL = 'https://api.github.com';
const REPO_OWNER = '你的GitHub用户名';
const REPO_NAME = '你的仓库名';

// 获取 Token (从 LocalStorage)
const getToken = () => localStorage.getItem('github_token');

const api = axios.create({
  baseURL: GITHUB_API_URL,
});

// 请求拦截器：注入 Token
api.interceptors.request.use(config => {
  const token = getToken();
  if (token) {
    config.headers.Authorization = `token ${token}`;
  }
  return config;
});

// 获取文件列表
export const getFiles = async (path) => {
  const response = await api.get(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`);
  return response.data;
};

// 获取文件内容
export const getFileContent = async (path) => {
  const response = await api.get(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`);
  // GitHub API 返回 content 为 base64，需解码
  return decodeURIComponent(escape(window.atob(response.data.content.replace(/\n/g, ''))));
};

// 上传/更新文件
export const uploadFile = async (path, contentBase64, message, sha = null) => {
  const data = {
    message,
    content: contentBase64,
  };
  if (sha) {
    data.sha = sha;
  }
  const response = await api.put(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, data);
  return response.data;
};
```

### 第三步：配置自动化部署 (GitHub Actions)
为了实现 `git push` 后自动构建并部署到 GitHub Pages，在仓库根目录创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ] # 监听 main 分支的提交

permissions:
  contents: write # 允许写入权限

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist # 构建输出目录
          branch: gh-pages # 部署分支
```

### 第四步：开发页面
1.  **Layout**: 包含 Header (导航), Footer, 以及 `MusicPlayer` 全局播放器。
2.  **Login.jsx**: Token 输入与验证。
3.  **Home.jsx**: 文章列表，支持按标签/分类筛选。
4.  **Post.jsx**: 文章详情，包含 `ReactMarkdown` 渲染内容和 `Giscus` 评论区。
5.  **Editor.jsx**: 集成 Markdown 编辑器 (如 `react-mde` 或简单的 `textarea`)，支持拖拽上传图片/音乐。

### 第五步：部署
1.  提交代码到 GitHub `main` 分支。
2.  GitHub Actions 会自动运行，构建项目并将 `dist` 目录推送到 `gh-pages` 分支。
3.  在仓库 Settings -> Pages 中，选择 Source 为 `gh-pages` 分支。

---

## 6. 注意事项与优化

### 6.1 安全性
*   **Token 保护**: GitHub PAT 拥有仓库读写权限，绝对不能泄露。前端存储在 `localStorage` 是方便之举，但存在 XSS 攻击风险。
*   **最小权限**: 申请 Token 时，只勾选必要的权限（如 `repo` 或 `public_repo`）。

### 6.2 性能优化
*   **缓存**: 利用浏览器缓存或 Service Worker 缓存 API 响应，减少 GitHub API 调用次数（GitHub API 有速率限制，未认证 60次/小时，认证 5000次/小时）。
*   **CDN**: 图片链接可以使用 `jsDelivr` CDN 加速，格式为 `https://cdn.jsdelivr.net/gh/{user}/{repo}/{path}`。

### 6.3 路由模式
GitHub Pages 不支持配置 Nginx 转发，因此 SPA 应用建议使用 `HashRouter` (`/#/post/1`) 而非 `BrowserRouter` (`/post/1`)，否则刷新页面会出现 404 错误。如果必须用 `BrowserRouter`，需要添加一个 `404.html` 重定向 hack 脚本。
